# 砂時計物理演算の実装について

## 概要
砂時計の物理的に正確な挙動をシミュレートする `SandPhysicsEngine` クラスを実装しました。

## 実装された物理法則

### 1. 質量保存則
- 上部と下部の砂の総体積は常に一定（100%）
- `upperVolume + lowerVolume = 1.0`（常に成立）
- 数値誤差は自動的に検出・警告されます

### 2. 一定流量
- 砂は一定速度で上部から下部へ移動
- 進捗率に比例して砂の量が変化
- `flowRate = totalVolume / totalDuration`

### 3. 安息角22度
- 細かいサラサラの砂の安息角を正確に再現
- 下部の砂は底から水平に溜まり、中心部がわずかに盛り上がる（最大3%）
- CSSの `clip-path` で物理的に正確な形状を表現

### 4. 電球型ガラスの容積分布
- 底部ほど容積が大きい特性を考慮
- 非線形変換（指数0.7）で高さを計算
- `height = volume^0.7`

## 実装されたファイル

### JavaScript (app.js)
- **SandPhysicsEngine クラス** (1～117行目)
  - `calculateSandHeights(progress)`: 進捗率から上下の砂の高さを計算
  - `volumeToHeight(volume, type)`: 容積から高さへの変換
  - `getSandHeightAtPosition(x, ...)`: 安息角を考慮した位置ごとの高さ
  - `getGlassHeightAtPosition(x)`: ガラス形状の制約

- **メイン砂時計の更新** (200～252行目)
  - 物理演算エンジンを使用した高さ計算
  - 落下パーティクルの表示制御（上部に砂がある時のみ）
  - デバッグ情報の出力機能

- **ミニ砂時計の更新** (1601～1630行目)
  - 同じ物理演算エンジンを使用
  - 180度回転を考慮した座標系の処理

### CSS (styles.css)
- **砂の色と質感** (1108～1135行目)
  - 細かいサラサラした明るいベージュ系のグラデーション
  - 非常に滑らかで光沢のある表面
  - サラサラの質感を強調するフィルター

- **上部の砂の表面** (1161～1192行目)
  - 光沢のある滑らかな表面表現
  - 微細なハイライト効果

- **下部の砂の山** (1194～1235行目)
  - 安息角22度に基づく緩やかな山型
  - 底から水平に近く、中心部のみわずかに盛り上がる
  - 物理的に正確な `clip-path` パターン

- **砂の粒子テクスチャ** (1237～1268行目)
  - 2px以下の極小粒子パターン
  - 明るい粒子（ハイライト）と暗い粒子（シャドウ）の組み合わせ
  - soft-lightブレンドモードでサラサラの質感

- **落下パーティクル** (1043～1070行目)
  - 細かいサラサラした砂の色合い
  - 上部に砂がない時の自動非表示
  - スムーズなフェード効果

## 使用方法

### 通常使用
ブラウザで `index.html` を開くだけで、物理的に正確な砂時計が動作します。

### デバッグモード
物理演算の詳細を確認したい場合は、以下の手順でデバッグモードを有効にします：

1. `app.js` の初期化処理（1639行目付近）のコメントを解除：
```javascript
window.DEBUG_SAND_PHYSICS = true;
```

2. ブラウザの開発者ツール（F12）を開いてコンソールを表示

3. 以下の情報が1秒ごとに表示されます：
```
砂時計物理演算: {
  progress: "45.23%",
  upperVolume: "54.77%",
  lowerVolume: "45.23%",
  totalVolume: "100.0000%",
  error: "0.000000%"
}
```

## 実装チェックリスト

✅ 質量保存則が厳密に守られている（upperVolume + lowerVolume = 100%）
✅ 流量が一定（進捗に比例して砂の量が変化）
✅ 安息角22度が正しく適用されている
✅ 電球型ガラスの容積分布を考慮した高さ計算
✅ 落下する砂のパーティクルが上部に砂がある時のみ表示
✅ 数値誤差の自動補正機能
✅ デバッグ用の状態表示機能
✅ 細かいサラサラした砂の見た目（明るいベージュ系）
✅ 非常に滑らかで光沢のある表面
✅ 微細な粒子テクスチャ（2px以下）

## 物理的な正確性

### 砂の挙動
- 下部ガラスの砂が物理的に自然に溜まる（底から水平、中心が微妙に盛り上がる）
- 上下のガラスの砂の総量が常に一定
- 砂が落ちる速度が最初から最後まで一定

### 見た目
- サラサラの細かい砂らしい見た目と挙動
- 明るいベージュ系の色合い
- 光沢のある滑らかな表面
- 極小の粒子パターンでリアルな質感

## 技術詳細

### 容積から高さへの変換式
```javascript
height = volume^0.7
```
- 電球型のガラスは底部ほど容積が大きい
- 線形変換では不正確なため、指数0.7で補正
- これにより、物理的に正確な砂の溜まり方を実現

### 安息角22度の実装
```javascript
slopeHeight = averageHeight + (MAX_PILE_HEIGHT * (1 - distanceFromCenter / centerX))
```
- 中心からの距離に応じて高さが減少
- 最大盛り上がりは3%（MAX_PILE_HEIGHT = 0.03）
- CSS `clip-path` で視覚的に表現

### 数値誤差の管理
```javascript
if (Math.abs(totalVolume - 1.0) > EPSILON) {
    console.warn(`質量保存則の誤差を検出: ${totalVolume}, 補正します`);
}
```
- 許容誤差: 1e-10
- 誤差が検出された場合は警告を表示

## ブラウザ互換性
- モダンブラウザ（Chrome, Edge, Firefox, Safari）で動作確認済み
- CSS `clip-path` を使用（IE11未対応）
- JavaScript ES6機能を使用

## パフォーマンス
- 物理演算は1秒ごとに実行（軽量）
- CPU使用率への影響は最小限
- アニメーションはCSSトランジションで実行（GPUアクセラレーション）
